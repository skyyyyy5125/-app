from fastapi import FastAPI
import requests
import pandas as pd
from datetime import datetime

CLIENT_ID = "請填入你的_CLIENT_ID"
CLIENT_SECRET = "請填入你的_CLIENT_SECRET"

TOKEN_URL = "https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token"
FREEWAY_URL = "https://tdx.transportdata.tw/api/basic/v2/Road/Traffic/Live/Freeway"


app = FastAPI(title="台灣國道交通預測系統")

speed_history = [] 

def get_access_token():
    data = {
        "grant_type": "client_credentials",
        "client_id": CLIENT_ID,
        "client_secret": CLIENT_SECRET
    }
    response = requests.post(TOKEN_URL, data=data)
    return response.json()["access_token"]

def get_freeway_data(token):
    headers = {"Authorization": f"Bearer {token}"}
    params = {"$format": "JSON"}
    response = requests.get(FREEWAY_URL, headers=headers, params=params)
    return response.json()

def predict_speed(history, window=5):
    if len(history) < window:
        return sum(history) / len(history)
    return sum(history[-window:]) / window

def congestion_level(speed):
    if speed >= 80:
        return "順暢"
    elif speed >= 60:
        return "普通"
    else:
        return "壅塞"

@app.get("/")
def root():
    return {"message": "Taiwan Freeway Traffic Prediction API is running"}

@app.get("/freeway/speed")
def freeway_speed():
    token = get_access_token()
    data = get_freeway_data(token)

    df = pd.json_normalize(data)
    df = df[df["AvgSpeed"].notna()]

    avg_speed = df["AvgSpeed"].mean()
    speed_history.append(avg_speed)

    predicted_speed = predict_speed(speed_history)

    return {
        "time": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "current_avg_speed": round(avg_speed, 2),
        "predicted_speed_10min": round(predicted_speed, 2),
        "traffic_status": congestion_level(avg_speed),
        "data_count": len(df)
    }
